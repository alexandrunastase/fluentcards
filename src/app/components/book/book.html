<div class="book" *ngIf="book">
  <div class="alert alert-danger" role="alert" [hidden]="!errorMessage">{{ errorMessage }}</div>

  <a class="book__close" [routerLink]="[ '/books' ]"><span class="book__close-icon">&times;</span></a>

  <div class="book__controls">
    <div class="book__control">
      <input id="definitions" type="checkbox"
             [disabled]="isLoadingDefinitions"
             [(ngModel)]="definitionsEnabled"
             (ngModelChange)="onToggleDefinitions($event)" />

      <label for="definitions">add definitions in&nbsp;</label>

      <select [(ngModel)]="language" (ngModelChange)="onLanguageSelect($event)">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
        <option value="es">Español</option>
        <option value="pt">Português</option>
        <option value="it">Italiano</option>
        <option value="pl">Polski</option>
        <option value="ru">Русский</option>
        <option value="zh">中文</option>
        <option value="ja">日本語</option>
      </select>

      <div class="book__loader">
        <loader [isLoading]="isLoadingDefinitions"></loader>
      </div>
    </div>

    <div class="book__control">
      <input id="pictures" type="checkbox"
             [disabled]="isLoadingImages"
             [(ngModel)]="imagesEnabled"
             (ngModelChange)="onToggleImages($event)" />

      <label for="pictures">add pictures</label>

      <div class="book__loader">
        <loader [isLoading]="isLoadingImages"></loader>
      </div>
    </div>

    <div class="book__control">
      <input id="cloze" type="checkbox" [(ngModel)]="clozeEnabled" (ngModelChange)="onToggleCloze($event)" />

      <label for="cloze">add cloze test</label>
    </div>

    <div class="book__control" *ngIf="hasSaveAs">
      <button class="btn btn-default btn-small" (click)="exportAnki()">
        Save as Anki deck
      </button>
    </div>

    <div class="book__control">
      <button class="btn btn-default btn-small" (click)="exportCsv()" title="TSV can be imported into Memrise or Anki">
        Save as TSV
      </button>
    </div>
  </div>

  <div class="book__container">
    <div class="book__header">
      <div class="book__header-item book__header-title">
        <img *ngIf="book.cover"
             [src]="book.cover"
             (error)="book.cover = null"
             class="book__cover pull-left"
             alt="{{ book.title }} cover" />

        <h4 class="book__title">
          {{ book.title }}<br />
          <small *ngIf="book.authors">by <em>{{ book.authors }}</em></small>
        </h4>
      </div>

      <div class="book__header-item book__count">
        <span class="book__count-number">{{ book.count }}</span>
        <span class="book__count-label">{{ book.count == 1 ? 'word' : 'words' }}</span>

        <div class="book__share" *ngIf="isShareable">
          <button class="btn btn-default btn-small" (click)="shareVocab()" [disabled]="isShared">
            {{ isShared ? 'Successfully shared' : 'Share with community' }}
          </button>
        </div>
      </div>
    </div>

    <div class="book__table-wrapper book__table-wrapper-{{ book.cover ? 'cover' : 'no-cover' }}">
      <table class="book__table table">
        <thead>
          <th style="width: 2em"></th>
          <th style="width: 4em">Image</th>
          <th width="17%">Word</th>
          <th width="17%" *ngIf="isLoadingDefinitions || book.vocabs[0].translation != null">Definition</th>
          <th width="60%" class="book__th-context">Context<span [hidden]="book.vocabs[0].cloze == null"> (with cloze test)</span></th>
          <th style="width: 3em"></th>
        </thead>

        <tbody>
          <tr *ngFor="let vocab of book.vocabs; let i = index">
            <td class="text-muted">{{ i + 1 }}</td>

            <td align="center">
              <img *ngIf="vocab.image" class="book__thumb" [src]="vocab.image.thumbnail" (click)="addImage(vocab)" />

              <i *ngIf="!vocab.preloadImage && !vocab.image"
                 class="fa fa-image text-muted book__get-image"
                 title="Set an image"
                 (click)="addImage(vocab)"></i>

              <loader [isLoading]="vocab.preloadImage"></loader>

              <div class="book__images" *ngIf="vocab.chooseImage">
                <vocab-images [word]="vocab.baseForm" [language]="book.language" (onResult)="onImageAdd($event, vocab)"></vocab-images>
              </div>

              <vocab-images *ngIf="vocab.preloadImage && !vocab.image"
                            [word]="vocab.baseForm" [language]="book.language" [single]="true"
                            (onResult)="onImageAdd($event, vocab)">
              </vocab-images>
            </td>

            <td class="book__word">
              {{ vocab.article || '' }}

              <editable [text]="vocab.baseForm" [noEmpty]="true" (onChange)="onBaseFormChange(vocab, $event)"></editable>

              <span><u [hidden]="!vocab.fl">{{ vocab.fl }}</u><b [hidden]="!vocab.num && (vocab.article || !vocab.gender)">, {{ vocab.num || vocab.gender }}</b></span>

              <i *ngIf="hasSpeechSynthesis" class="fa fa-volume-up text-muted book__speak" (click)="speakWord(vocab.baseForm)"></i>

              <div *ngIf="vocab.reading || (vocab.definition && vocab.definition.ts)" class="book__ts text-muted">
                [{{ vocab.reading || vocab.definition.ts }}]
              </div>
            </td>

            <td *ngIf="isLoadingDefinitions || book.vocabs[0].translation != null">
              <editable *ngIf="vocab.translation != null" [text]="vocab.translation"
                        (onChange)="onTranslationChange(vocab, $event)"></editable>

              <span [hidden]="vocab.translation != null"><loader [isLoading]="isLoadingDefinitions"></loader></span>
            </td>

            <td class="book__context">
              <editable [text]="vocab.cloze || vocab.context" [isBlock]="true" (onChange)="onContextChange(vocab, $event)"></editable>
            </td>

            <td><i class="fa fa-remove text-muted book__remove-vocab" (click)="removeVocab(i)" title="Remove"></i></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
